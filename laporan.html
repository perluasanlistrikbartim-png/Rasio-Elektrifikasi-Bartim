<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Resmi Rasio Elektrifikasi ‚Äì Kabupaten Barito Timur</title>

<style>
/* =====================================================
   RESET & THEME
===================================================== */
html,body{
  margin:0;
  padding:0;
  background:#020216;
  color:#e0f7ff;
  font-family:Segoe UI, Arial, sans-serif;
}

/* =====================================================
   HEADER
===================================================== */
header{
  background:#000814;
  border-bottom:3px solid #f4b400;
  position:relative;
  overflow:hidden;
}

header::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(
    120deg,
    transparent 30%,
    rgba(255,255,255,.2),
    transparent 70%
  );
  transform:translateX(-120%);
  animation:kilat 6s infinite;
}

@keyframes kilat{
  0%,85%{transform:translateX(-120%)}
  100%{transform:translateX(120%)}
}

.header-inner{
  max-width:1200px;
  margin:auto;
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
}

.header-logo img{
  height:46px;
  filter:drop-shadow(0 0 6px rgba(244,180,0,.6));
}

.header-title h1{
  margin:0;
  font-size:1.4rem;
  font-weight:800;
}

.header-title span{
  font-size:13px;
  color:#ffe08a;
}

/* =====================================================
   CONTAINER
===================================================== */
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
}

/* =====================================================
   FILTER
===================================================== */
.filter-box{
  background:linear-gradient(180deg,#071a33,#050f22);
  border-radius:16px;
  padding:16px;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 0 22px rgba(0,180,255,.25);
  margin-bottom:18px;
}

.filter-form{
  display:grid;
  grid-template-columns:1fr 1fr auto;
  gap:12px;
}

.filter-form select,
.filter-form button{
  padding:10px;
  border-radius:10px;
  border:none;
  background:#071a33;
  color:#fff;
}

.filter-form button{
  background:#f4b400;
  color:#000;
  font-weight:800;
  cursor:pointer;
}

/* =====================================================
   INFO SNAPSHOT
===================================================== */
.info-box{
  text-align:center;
  margin-bottom:14px;
}

.info-box .title{
  font-size:14px;
  color:#9ecbff;
}

.info-box .value{
  font-size:22px;
  font-weight:900;
  color:#00e5ff;
}

/* =====================================================
   BOX TABLE
===================================================== */
.box-table{
  background:linear-gradient(180deg,#071a33,#050f22);
  border-radius:18px;
  padding:14px;
  margin-bottom:26px;
}

.table-scroll{
  max-height:60vh;
  overflow:auto;
}

/* =====================================================
   TABLE GLOBAL (AMAN)
===================================================== */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid rgba(0,180,255,.3);
}

/* =====================================================
   TABEL 1 ‚Äì DETAIL DESA (FIX HEADER)
===================================================== */
#tbl{
  table-layout:auto;
}

/* HEADER TABEL 1 ‚Üí STICKY SATU LAPIS SAJA */
/* ===============================
   TABEL 1 ‚Äì TANPA STICKY (STABIL)
================================ */
#tbl thead th{
  position:static;
  background:#0b2442;
  color:#7dd3fc;
  white-space:normal;
  text-align:center;
  line-height:1.25;
}


/* BODY TABEL 1 */
#tbl td{
  white-space:nowrap;
}

/* Lebar kolom Tabel 1 */
#tbl th:nth-child(1), #tbl td:nth-child(1){ width:42px; }
#tbl th:nth-child(2){ width:160px; }
#tbl th:nth-child(3){ width:180px; }
#tbl th:nth-child(4), #tbl th:nth-child(5){ width:80px; }
#tbl th:nth-child(6), #tbl th:nth-child(7), #tbl th:nth-child(8){ width:90px; }
#tbl th:nth-child(9){ width:120px; }
#tbl th:nth-child(10){ width:110px; }
#tbl th:nth-child(11),
#tbl th:nth-child(12),
#tbl th:nth-child(13),
#tbl th:nth-child(14){ width:120px; }

/* =====================================================
   TABEL 2 ‚Äì REKAP KECAMATAN (FINAL PRODUKSI)
   - Sticky 2 baris stabil
   - Tidak overlap
   - Aman mobile
===================================================== */
#tblRekap{
  width:100%;
  table-layout:fixed;          /* WAJIB untuk sticky stabil */
  border-collapse:separate;
  border-spacing:0;
}

/* ===================== CELL UMUM ===================== */
#tblRekap th,
#tblRekap td{
  padding:8px 10px;
  border-bottom:1px solid rgba(0,180,255,.3);
  font-size:13px;
}

/* ===================== HEADER ===================== */
#tblRekap thead th{
  background:#0b2442;
  color:#7dd3fc;
  text-align:center;
  white-space:normal;          /* BOLEH WRAP */
  line-height:1.25;
  vertical-align:middle;
  position:sticky;
}

/* BARIS HEADER 1 */
#tblRekap thead tr:first-child th{
  top:0;
  z-index:6;
  height:38px;
}

/* BARIS HEADER 2 */
#tblRekap thead tr:nth-child(2) th{
  top:38px;
  z-index:5;
  height:32px;
}

/* ===================== BODY ===================== */
#tblRekap tbody td{
  text-align:center;
  white-space:nowrap;          /* DATA TIDAK PECAH */
}

/* Kecamatan rata kiri & boleh turun baris */
#tblRekap tbody td:nth-child(2){
  text-align:left;
  white-space:normal;
}

/* ===================== LEBAR KOLOM (ANTI TABRAKAN) ===================== */
#tblRekap th:nth-child(1),
#tblRekap td:nth-child(1){ width:48px; }    /* No */

#tblRekap th:nth-child(2),
#tblRekap td:nth-child(2){ width:190px; }   /* Kecamatan */

#tblRekap th:nth-child(3),
#tblRekap td:nth-child(3){ width:120px; }   /* Jumlah Kelurahan */

#tblRekap th:nth-child(4),
#tblRekap td:nth-child(4){ width:110px; }   /* Jumlah Desa */

#tblRekap th:nth-child(5),
#tblRekap td:nth-child(5){ width:90px; }    /* Desa PLN */

#tblRekap th:nth-child(6),
#tblRekap td:nth-child(6){ width:90px; }    /* Desa Non PLN */

#tblRekap th:nth-child(7),
#tblRekap td:nth-child(7){ width:140px; }   /* Desa Belum Berlistrik */

#tblRekap th:nth-child(8),
#tblRekap td:nth-child(8){ width:100px; }   /* RT PLN */

#tblRekap th:nth-child(9),
#tblRekap td:nth-child(9){ width:100px; }   /* RT Non PLN */

#tblRekap th:nth-child(10),
#tblRekap td:nth-child(10){ width:110px; }  /* RT Jumlah */

#tblRekap th:nth-child(11),
#tblRekap td:nth-child(11){ width:150px; }  /* RT Belum Berlistrik */

#tblRekap th:nth-child(12),
#tblRekap td:nth-child(12){ width:120px; }  /* Total RT */

#tblRekap th:nth-child(13),
#tblRekap td:nth-child(13){ width:120px; }  /* Rasio PLN */

#tblRekap th:nth-child(14),
#tblRekap td:nth-child(14){ width:140px; }  /* Rasio Non PLN */

#tblRekap th:nth-child(15),
#tblRekap td:nth-child(15){ width:130px; }  /* Rasio Elektrifikasi */

#tblRekap th:nth-child(16),
#tblRekap td:nth-child(16){ width:150px; }  /* Rasio Desa Berlistrik */

/* ===================== MOBILE TWEAK ===================== */
@media(max-width:768px){
  #tblRekap th,
  #tblRekap td{
    font-size:12px;
    padding:6px 8px;
  }

  #tblRekap thead tr:first-child th{
    height:42px;
  }

  #tblRekap thead tr:nth-child(2) th{
    top:42px;
  }
}
/* =====================================================
   FREEZE KOLOM KIRI (NO + KECAMATAN) ‚Äì TABEL 2
===================================================== */
#tblRekap th:nth-child(1),
#tblRekap td:nth-child(1){
  position:sticky;
  left:0;
  z-index:6;
  background:#0b2442;
}

#tblRekap th:nth-child(2),
#tblRekap td:nth-child(2){
  position:sticky;
  left:48px; /* lebar kolom No */
  z-index:6;
  background:#0b2442;
}

/* Body beda warna sedikit */
#tblRekap tbody td:nth-child(1),
#tblRekap tbody td:nth-child(2){
  background:#071a33;
}


/* =====================================================
   RESUME KABUPATEN (FIT KIRI)
===================================================== */
.resume-box{
  width:480px;
  max-width:480px;
  margin:12px 0 0 0;
  background:linear-gradient(180deg,#061a30,#040e1f);
  border-radius:18px;
  padding:16px 18px;
  border:1px solid rgba(0,180,255,.25);
  box-shadow:0 0 24px rgba(0,180,255,.25);
}

.resume-box h3{
  margin:0 0 14px;
  text-align:center;
  color:#ffe08a;
  font-size:15px;
}

.resume-table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

.resume-table td{
  padding:9px 8px;
  border-bottom:1px dashed rgba(0,180,255,.25);
}

.resume-table td:nth-child(1){
  width:36px;
  text-align:center;
  font-weight:700;
  color:#7dd3fc;
}

.resume-table td:nth-child(2){
  color:#9ecbff;
}

.resume-table td:nth-child(3){
  text-align:right;
  font-weight:900;
  color:#00e5ff;
}

/* =====================================================
   MODE CETAK / PDF
===================================================== */
@media print{
  body{
    background:#fff;
    color:#000;
  }

  header, .filter-box, footer{
    display:none !important;
  }

  .box-table, .resume-box{
    box-shadow:none;
    border:1px solid #000;
  }

  table{
    font-size:11px;
  }

  th,td{
    border:1px solid #000;
  }

  thead th{
    position:static !important;
  }
}
/* ================= EXPORT DROPDOWN ================= */
.export-box{
  position:relative;
  display:inline-block;
  margin:12px 0;
}

.export-btn{
  padding:8px 14px;
  background:#f4b400;
  color:#000;
  border:none;
  border-radius:8px;
  font-weight:800;
  cursor:pointer;
}

.export-menu{
  display:none;
  position:absolute;
  top:100%;
  left:0;
  min-width:180px;
  background:#071a33;
  border:1px solid rgba(255,255,255,.15);
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
  z-index:99;
}

.export-menu div{
  padding:10px 14px;
  cursor:pointer;
  color:#e0f7ff;
}

.export-menu div:hover{
  background:#0b2442;
}

/* tampil saat hover */
.export-box:hover .export-menu{
  display:block;
}
@media print{
  .table-scroll{
    max-height:none !important;
    overflow:visible !important;
  }

  thead th{
    position:static !important;
  }

  .resume-box{
    break-inside:avoid;
    margin-top:16px;
  }
}
body.mode-pdf{
  background:#fff !important;
  color:#000 !important;
}

body.mode-pdf *{
  box-shadow:none !important;
  border-radius:0 !important;
}

body.mode-pdf th{
  background:#cfe2f3 !important;
  color:#000 !important;
  border:1px solid #000;
}

body.mode-pdf td{
  border:1px solid #000;
}

body.mode-pdf .table-scroll{
  overflow:visible !important;
  max-height:none !important;
}

body.mode-pdf thead th{
  position:static !important;
}

</style>


</head>

<body>

<header>
  <div class="header-inner">
    <div class="header-logo">
      <img src="bartim.png" alt="Bartim">
    </div>
    <div class="header-title">
      <h1>Laporan Resmi Rasio Elektrifikasi</h1>
      <span>Kabupaten Barito Timur</span>
    </div>
  </div>
</header>

<div class="container">

  <!-- FILTER -->
  <div class="filter-box">
    <h3>üìÑ Pilih Periode Laporan (Snapshot)</h3>
    <div class="filter-form">
      <select id="tahun">
        <option value="">‚Äî Tahun ‚Äî</option>
        <option>2025</option>
        <option>2026</option>
        <option>2027</option>
      </select>
      <select id="triwulan">
        <option value="">‚Äî Triwulan ‚Äî</option>
        <option value="I">Triwulan I</option>
        <option value="II">Triwulan II</option>
        <option value="III">Triwulan III</option>
        <option value="IV">Triwulan IV</option>
      </select>
      <button onclick="loadLaporan()">üîç Tampilkan</button>
    </div>
  </div>

  <!-- INFO -->
  <div class="info-box" id="info" style="display:none">
    <div class="title" id="infoTitle"></div>
    <div class="value" id="infoValue"></div>
  </div>

  <!-- ===================== TABEL 1 ===================== -->
  <div class="box-table">
    <div class="table-scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th rowspan="2">No</th>
            <th rowspan="2">Kecamatan</th>
            <th rowspan="2">Desa / Kelurahan</th>
            <th colspan="2">Desa / Kelurahan Berlistrik</th>
            <th colspan="3">Rumah Tangga Berlistrik</th>
            <th rowspan="2">Jumlah Rumah Tangga<br>Belum Berlistrik</th>
            <th rowspan="2">Total Rumah Tangga</th>
            <th rowspan="2">Rasio Elektrifikasi PLN</th>
            <th rowspan="2">Rasio Elektrifikasi Non PLN</th>
            <th rowspan="2">Rasio Elektrifikasi</th>
            <th rowspan="2">% Rumah Tangga Tidak Berlistrik</th>
            <th rowspan="2">Keterangan</th>
          </tr>
          <tr>
            <th>PLN</th>
            <th>Non PLN</th>
            <th>PLN</th>
            <th>Non PLN</th>
            <th>Jumlah</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="3">TOTAL</td>
            <td>-</td>
            <td>-</td>
            <td id="tPln"></td>
            <td id="tNon"></td>
            <td id="tBerlistrik"></td>
            <td id="tTidak"></td>
            <td id="tJml"></td>
            <td colspan="5"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- ===== JARAK ANTAR TABEL ===== -->
  <div style="height:32px"></div>

  <!-- ===================== WRAPPER REKAP ===================== -->
  <div class="rekap-wrapper">

    <!-- JUDUL TABEL 2 -->
    <div class="laporan-title">
      <div class="laporan-title-main">
        RASIO ELEKTRIFIKASI DAN RASIO KELURAHAN/DESA BERLISTRIK BARITO TIMUR
      </div>
      <div class="laporan-title-sub">
        PROVINSI KALIMANTAN TENGAH
      </div>
      <div class="laporan-title-periode">
        (REKAP PER KECAMATAN)
      </div>
    </div>
<div class="export-box">
  <button onclick="toggleExport()">‚¨á Export</button>
  <div id="exportMenu" style="display:none">
    <button onclick="exportExcel()">üìä Excel</button>
    <button onclick="exportPDF()">üìÑ PDF</button>
  </div>
</div>

<script>
function toggleExport(){
  const m = document.getElementById("exportMenu");
  m.style.display = m.style.display==="block" ? "none":"block";
}
</script>

    <!-- ===================== TABEL 2 ===================== -->
    <div class="box-table">
      <div class="table-scroll">
        <table id="tblRekap">
          <thead>
            <tr>
              <th rowspan="2">No</th>
              <th rowspan="2">Kecamatan</th>
              <th rowspan="2">Jumlah Kelurahan</th>
              <th rowspan="2">Jumlah Desa</th>
              <th colspan="2">Desa / Kelurahan Berlistrik</th>
              <th rowspan="2">Desa / Kelurahan<br>Belum Berlistrik</th>
              <th colspan="3">Rumah Tangga Berlistrik</th>
              <th rowspan="2">Jumlah Rumah Tangga<br>Belum Berlistrik</th>
              <th rowspan="2">Total Rumah Tangga</th>
              <th rowspan="2">Rasio Elektrifikasi PLN</th>
              <th rowspan="2">Rasio Elektrifikasi Non PLN</th>
              <th rowspan="2">Rasio Elektrifikasi</th>
              <th rowspan="2">Rasio Desa Berlistrik</th>
            </tr>
            <tr>
              <th>PLN</th>
              <th>Non PLN</th>
              <th>PLN</th>
              <th>Non PLN</th>
              <th>Jumlah</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="16" style="text-align:center;color:#9ecbff">
                Data rekap kecamatan akan tampil setelah perhitungan
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===================== RESUME (TABEL 3) ===================== -->
    <div class="resume-box" id="resumeBox" style="display:none">
      <h3>Rangkuman Kabupaten Barito Timur</h3>
      <table class="resume-table">
        <tr><td>1</td><td>Jumlah Kecamatan</td><td id="rKec"></td></tr>
        <tr><td>2</td><td>Jumlah Kelurahan</td><td id="rKel"></td></tr>
        <tr><td>3</td><td>Jumlah Desa</td><td id="rDesa"></td></tr>
        <tr><td>4</td><td>Desa/Kelurahan Berlistrik</td><td id="rDesaListrik"></td></tr>
        <tr><td>5</td><td>Rasio Desa/Kelurahan Berlistrik</td><td id="rRasioDesa"></td></tr>
        <tr><td>6</td><td>Rasio Elektrifikasi PLN</td><td id="rPln"></td></tr>
        <tr><td>7</td><td>Rasio Elektrifikasi Non PLN</td><td id="rNon"></td></tr>
        <tr><td>8</td><td>Rasio Elektrifikasi Kabupaten</td><td id="rTotal"></td></tr>
        <tr><td>9</td><td>Persentase RT Tidak Berlistrik</td><td id="rTidak"></td></tr>
      </table>
    </div>

  </div><!-- END rekap-wrapper -->

</div><!-- END container -->



<footer>
  <div class="footer-inner">
    <div>
      <div class="footer-title">WebGIS Rasio Elektrifikasi</div>
      <div class="footer-sub">
        DPUPRPERKIM Kabupaten Barito Timur<br>
        Sekretariat Daerah Kabupaten Barito Timur
      </div>
    </div>
    <div class="footer-sub">
      ¬© 2025 ‚Äì Laporan Resmi (Snapshot Terkunci)
    </div>
  </div>
</footer>

<script>
/* =====================================================
   CONFIG & GLOBAL STORAGE
===================================================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxa-soCZiiqGB86ND1s5tKaIBwHSz0OGmv9OgJoDXYLKS1DvgcGy6e1sInZI3JD0oSm/exec";

let dataRekapArray = [];
let resumeArray = [];
let periodeText = "";

/* =====================================================
   UTIL
===================================================== */
function formatPersen(v){
  const n = Number(v || 0);
  return (n * 100).toLocaleString("id-ID",{minimumFractionDigits:2}) + " %";
}

/* =====================================================
   LOAD LAPORAN
===================================================== */
function loadLaporan(){

  const tahun = document.getElementById("tahun").value;
  const triwulan = document.getElementById("triwulan").value;
  if(!tahun || !triwulan){
    alert("Pilih tahun & triwulan");
    return;
  }

  periodeText = `TRIWULAN ${triwulan} TAHUN ${tahun}`;

  fetch(`${API_URL}?action=getLaporan&tahun=${tahun}&triwulan=${triwulan}`)
    .then(r=>r.json())
    .then(res=>{
      if(res.status!=="ok") return alert("Data tidak ditemukan");

      /* ================== TABEL 1 ================== */
      const tb1=document.querySelector("#tbl tbody");
      tb1.innerHTML="";
      let sPln=0,sNon=0,sBL=0,sTB=0,sTot=0;

      res.data.forEach((d,i)=>{
        const rtBL=(+d.rt_pln||0)+(+d.rt_non_pln||0);
        sPln+=+d.rt_pln||0;
        sNon+=+d.rt_non_pln||0;
        sBL+=rtBL;
        sTB+=+d.rt_non_listrik||0;
        sTot+=+d.jumlah||0;

        tb1.innerHTML+=`
<tr>
<td>${i+1}</td><td>${d.kecamatan}</td><td>${d.desa}</td>
<td>${d.desa_pln||"-"}</td><td>${d.desa_non_pln||"-"}</td>
<td>${d.rt_pln}</td><td>${d.rt_non_pln}</td><td>${rtBL}</td>
<td>${d.rt_non_listrik}</td><td>${d.jumlah}</td>
<td>${formatPersen(d.persen_pln)}</td>
<td>${formatPersen(d.persen_non_pln)}</td>
<td>${formatPersen(d.persen_berlistrik)}</td>
<td>${formatPersen(d.persen_tidak_berlistrik)}</td>
<td>-</td>
</tr>`;
      });

      tPln.innerText=sPln;
      tNon.innerText=sNon;
      tBerlistrik.innerText=sBL;
      tTidak.innerText=sTB;
      tJml.innerText=sTot;

      info.style.display="block";
      infoTitle.innerText=`Laporan Resmi ${periodeText}`;
      infoValue.innerText=`${res.total_desa} Desa/Kelurahan`;

      /* ================== AGREGASI TABEL 2 ================== */
      const map={};
      res.data.forEach(d=>{
        if(!map[d.kecamatan]){
          map[d.kecamatan]={kel:0,desa:0,pln:0,non:0,bl:0,rtp:0,rtn:0,rtbl:0,rttb:0,total:0};
        }
        const m=map[d.kecamatan];
        if(/^Kel/i.test(d.desa)) m.kel++; else m.desa++;
        if(d.desa_pln==="Ya") m.pln++;
        if(d.desa_non_pln==="Ya") m.non++;
        if(d.desa_pln==="Ya"||d.desa_non_pln==="Ya") m.bl++;
        m.rtp+=+d.rt_pln||0;
        m.rtn+=+d.rt_non_pln||0;
        m.rtbl+= (+d.rt_pln||0)+(+d.rt_non_pln||0);
        m.rttb+=+d.rt_non_listrik||0;
        m.total+=+d.jumlah||0;
      });

      /* ================== TABEL 2 HTML + ARRAY ================== */
      dataRekapArray=[];
      document.querySelector("#tblRekap tbody").innerHTML="";
      let no=1;

      Object.keys(map).forEach(k=>{
        const m=map[k];
        const rPln=m.total?m.rtp/m.total:0;
        const rNon=m.total?m.rtn/m.total:0;
        const rTot=m.total?m.rtbl/m.total:0;
        const rDesa=(m.kel+m.desa)?m.bl/(m.kel+m.desa):0;

        dataRekapArray.push([
          no,k,m.kel,m.desa,
          m.pln,m.non,(m.kel+m.desa)-m.bl,
          m.rtp,m.rtn,m.rtbl,
          m.rttb,m.total,
          formatPersen(rPln),formatPersen(rNon),
          formatPersen(rTot),formatPersen(rDesa)
        ]);

        tblRekap.querySelector("tbody").innerHTML+=`
<tr>
<td>${no++}</td><td>${k}</td><td>${m.kel}</td><td>${m.desa}</td>
<td>${m.pln}</td><td>${m.non}</td><td>${(m.kel+m.desa)-m.bl}</td>
<td>${m.rtp}</td><td>${m.rtn}</td><td>${m.rtbl}</td>
<td>${m.rttb}</td><td>${m.total}</td>
<td>${formatPersen(rPln)}</td><td>${formatPersen(rNon)}</td>
<td>${formatPersen(rTot)}</td><td>${formatPersen(rDesa)}</td>
</tr>`;
      });

      /* ================== RESUME ================== */
      const totKec=Object.keys(map).length;
      let totKel=0,totDesa=0,totBL=0,rtp=0,rtn=0,rtbl=0,rttb=0,rtTot=0;
      Object.values(map).forEach(m=>{
        totKel+=m.kel; totDesa+=m.desa; totBL+=m.bl;
        rtp+=m.rtp; rtn+=m.rtn; rtbl+=m.rtbl; rttb+=m.rttb; rtTot+=m.total;
      });

      resumeArray=[
        ["Jumlah Kecamatan",totKec],
        ["Jumlah Kelurahan",totKel],
        ["Jumlah Desa",totDesa],
        ["Desa/Kelurahan Berlistrik",totBL],
        ["Rasio Desa/Kelurahan Berlistrik",formatPersen(totBL/(totKel+totDesa))],
        ["Rasio Elektrifikasi PLN",formatPersen(rtp/rtTot)],
        ["Rasio Elektrifikasi Non PLN",formatPersen(rtn/rtTot)],
        ["Rasio Elektrifikasi Kabupaten",formatPersen(rtbl/rtTot)],
        ["Persentase RT Tidak Berlistrik",formatPersen(rttb/rtTot)]
      ];

      resumeBox.style.display="block";
      resumeArray.forEach((r,i)=>{
        document.getElementById(["rKec","rKel","rDesa","rDesaListrik","rRasioDesa","rPln","rNon","rTotal","rTidak"][i]).innerText=r[1];
      });
    });
}


</script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script>
function exportExcel(){

  /* ================= CLONE TABEL HTML ================= */
  const srcTable = document.getElementById("tblRekap");
  if(!srcTable){
    alert("Tabel rekap belum tersedia");
    return;
  }

  const table = srcTable.cloneNode(true);

  /* bersihkan style web (sticky dll) */
  table.querySelectorAll("*").forEach(el=>{
    el.style.position = "static";
    el.style.left = "";
    el.style.top = "";
  });

  /* ================= BUAT WORKBOOK ================= */
  const wb = XLSX.utils.book_new();

  /* ================= KONVERSI TABEL ================= */
  const ws = XLSX.utils.table_to_sheet(table, { raw:true });

  /* ================= JUDUL ================= */
  XLSX.utils.sheet_add_aoa(ws, [
    ["RASIO ELEKTRIFIKASI DAN RASIO KELURAHAN/DESA BERLISTRIK BARITO TIMUR"],
    ["PROVINSI KALIMANTAN TENGAH"],
    [periodeText],
    []
  ], { origin:"A1" });

  /* ================= MERGE JUDUL ================= */
  ws["!merges"] = [
    { s:{r:0,c:0}, e:{r:0,c:15} },
    { s:{r:1,c:0}, e:{r:1,c:15} },
    { s:{r:2,c:0}, e:{r:2,c:15} }
  ];

  /* ================= FREEZE (judul + 2 header) ================= */
  ws["!freeze"] = { xSplit:0, ySplit:6 };

  /* ================= LEBAR KOLOM (MENYESUAIKAN PDF) ================= */
  ws["!cols"] = [
    {wch:5},   // No
    {wch:26},  // Kecamatan (LEBAR)
    {wch:14},  // Jumlah Kel
    {wch:14},  // Jumlah Desa
    {wch:10},  // PLN
    {wch:10},  // Non PLN
    {wch:16},  // Belum Berlistrik
    {wch:10},  // RT PLN
    {wch:10},  // RT Non
    {wch:12},  // RT Jumlah
    {wch:16},  // RT Belum
    {wch:14},  // Total RT
    {wch:16},  // Rasio PLN
    {wch:18},  // Rasio Non PLN
    {wch:16},  // Rasio Total
    {wch:18}   // Rasio Desa
  ];

  /* ================= FORMAT CELL ================= */
  Object.keys(ws).forEach(addr=>{
    if(addr[0]==="!") return;
    const cell = ws[addr];

    /* BORDER GRID */
    cell.s = cell.s || {};
    cell.s.border = {
      top:{style:"thin"},
      bottom:{style:"thin"},
      left:{style:"thin"},
      right:{style:"thin"}
    };

    /* HEADER STYLE */
    if(addr.match(/^[A-Z]+5$/) || addr.match(/^[A-Z]+6$/)){
      cell.s.fill = { fgColor:{rgb:"CFE2F3"} };
      cell.s.font = { bold:true };
      cell.s.alignment = {
        horizontal:"center",
        vertical:"center",
        wrapText:true
      };
    }else{
      /* BODY */
      cell.s.alignment = {
        horizontal:"center",
        vertical:"center",
        wrapText:false
      };
    }

    /* 0 ‚Üí "-" */
    if(cell.v === 0 || cell.v === "0"){
      cell.v = "-";
      cell.t = "s";
    }

    /* PERSEN ‚Üí 2 DESIMAL */
    if(typeof cell.v === "string" && cell.v.includes("%")){
      const n = Number(cell.v.replace("%","").replace(",","."));
      if(!isNaN(n)){
        cell.v = n.toLocaleString("id-ID",{
          minimumFractionDigits:2,
          maximumFractionDigits:2
        }) + " %";
        cell.t = "s";
      }
    }
  });

  XLSX.utils.book_append_sheet(wb, ws, "Rekap Kecamatan");

  /* ================= SHEET RANGKUMAN ================= */
  const ws2 = XLSX.utils.aoa_to_sheet([
    ["RANGKUMAN KABUPATEN BARITO TIMUR"],
    [],
    ["Indikator","Nilai"],
    ...resumeArray
  ]);

  ws2["!merges"] = [
    { s:{r:0,c:0}, e:{r:0,c:1} }
  ];

  ws2["!cols"] = [
    {wch:40},
    {wch:18}
  ];

  /* border & format rangkuman */
  Object.keys(ws2).forEach(a=>{
    if(a[0]==="!") return;
    ws2[a].s = {
      border:{
        top:{style:"thin"},
        bottom:{style:"thin"},
        left:{style:"thin"},
        right:{style:"thin"}
      },
      alignment:{
        vertical:"center",
        horizontal: a.endsWith("B") ? "right":"left"
      }
    };
  });

  XLSX.utils.book_append_sheet(wb, ws2, "Rangkuman");

  /* ================= SIMPAN ================= */
  XLSX.writeFile(wb, "Laporan_Rasio_Elektrifikasi.xlsx");
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "mm", "a4");

  document.body.classList.add("mode-pdf");

  /* ===== JUDUL ===== */
  doc.setFontSize(11);
  doc.text(
    "RASIO ELEKTRIFIKASI DAN RASIO KELURAHAN/DESA BERLISTRIK BARITO TIMUR",
    148, 9, { align:"center" }
  );
  doc.setFontSize(9);
  doc.text(
    "PROVINSI KALIMANTAN TENGAH ‚Äì " + periodeText,
    148, 14, { align:"center" }
  );

  /* ===== TABEL 2 ===== */
  doc.autoTable({
    html:"#tblRekap",
    startY:18,
    theme:"grid",

    styles:{
      fontSize:7.2,
      cellPadding:1.4,
      halign:"center",
      valign:"middle"
    },

    headStyles:{
      fillColor:[207,226,243],
      textColor:0,
      fontStyle:"bold",
      lineWidth:0.3,
      lineColor:[0,0,0]
    },

    columnStyles:{
      1:{ cellWidth:36, halign:"left" } // Kecamatan
    },

    didParseCell(data){
      if(data.section==="body"){
        if(data.cell.raw === 0 || data.cell.raw === "0"){
          data.cell.text=["-"];
        }

        if(typeof data.cell.raw==="string" && data.cell.raw.includes("%")){
          const n = Number(
            data.cell.raw.replace("%","").replace(",",".")
          );
          if(!isNaN(n)){
            data.cell.text=[
              n.toLocaleString("id-ID",{
                minimumFractionDigits:2,
                maximumFractionDigits:2
              })+" %"
            ];
          }
        }

        if(data.column.index===1){
          data.cell.styles.fontSize=6.6; // Kecamatan
        }
      }
    }
  });

  /* ===== RESUME ===== */
  doc.autoTable({
    startY:doc.lastAutoTable.finalY+4,
    body:resumeArray.map(r=>[r[0],r[1]]),
    theme:"grid",
    tableWidth:120,
    margin:{left:14},

    styles:{fontSize:8,cellPadding:2},
    columnStyles:{
      0:{cellWidth:80,halign:"left"},
      1:{cellWidth:40,halign:"right"}
    },

    didParseCell(data){
      if(data.cell.raw === 0 || data.cell.raw==="0"){
        data.cell.text=["-"];
      }
      if(typeof data.cell.raw==="string" && data.cell.raw.includes("%")){
        const n = Number(
          data.cell.raw.replace("%","").replace(",",".")
        );
        if(!isNaN(n)){
          data.cell.text=[
            n.toLocaleString("id-ID",{
              minimumFractionDigits:2,
              maximumFractionDigits:2
            })+" %"
          ];
        }
      }
    }
  });

  doc.save("Laporan_Rasio_Elektrifikasi.pdf");
}


   
</script>


</body>
</html>
