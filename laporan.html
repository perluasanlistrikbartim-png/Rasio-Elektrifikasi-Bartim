<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Resmi Rasio Elektrifikasi ‚Äì Kabupaten Barito Timur</title>

<style>
/* =====================================================
   RESET & THEME (SAMA DENGAN INDEX)
===================================================== */
html,body{
  margin:0;
  padding:0;
  background:#020216;
  color:#e0f7ff;
  font-family:Segoe UI, Arial, sans-serif;
}

/* =====================================================
   HEADER + ANIMASI KILAT
===================================================== */
header{
  background:#000814;
  border-bottom:3px solid #f4b400;
  position:relative;
  overflow:hidden;
}

header::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(
    120deg,
    transparent 30%,
    rgba(255,255,255,.2),
    transparent 70%
  );
  transform:translateX(-120%);
  animation:kilat 6s infinite;
}

@keyframes kilat{
  0%,85%{transform:translateX(-120%)}
  100%{transform:translateX(120%)}
}

.header-inner{
  max-width:1200px;
  margin:auto;
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
}

.header-logo img{
  height:46px;
  filter:drop-shadow(0 0 6px rgba(244,180,0,.6));
}

.header-title{
  text-align:center;
}

.header-title h1{
  margin:0;
  font-size:1.4rem;
  font-weight:800;
  color:#fff;
}

.header-title span{
  font-size:13px;
  color:#ffe08a;
}

/* =====================================================
   CONTAINER
===================================================== */
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
}

/* =====================================================
   FILTER LAPORAN
===================================================== */
.filter-box{
  background:linear-gradient(180deg,#071a33,#050f22);
  border-radius:16px;
  padding:16px;
  box-shadow:0 0 22px rgba(0,180,255,.25);
  border:1px solid rgba(255,255,255,.08);
  margin-bottom:18px;
}

.filter-box h3{
  margin:0 0 10px;
  color:#ffe08a;
}

.filter-form{
  display:grid;
  grid-template-columns:1fr 1fr auto;
  gap:12px;
}

.filter-form select,
.filter-form button{
  padding:10px;
  border-radius:10px;
  border:none;
  background:#071a33;
  color:#fff;
}

.filter-form button{
  background:#f4b400;
  color:#000;
  font-weight:800;
  cursor:pointer;
}

/* =====================================================
   INFO SNAPSHOT
===================================================== */
.info-box{
  text-align:center;
  margin-bottom:14px;
}

.info-box .title{
  font-size:14px;
  color:#9ecbff;
}

.info-box .value{
  font-size:22px;
  font-weight:900;
  color:#00e5ff;
}

/* =====================================================
   TABLE LAPORAN
===================================================== */
.box-table{
  background:linear-gradient(180deg,#071a33,#050f22);
  border-radius:18px;
  padding:14px;
}

.table-scroll{
  max-height:60vh;
  overflow:auto;
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid rgba(0,180,255,.3);
}

th{
  position:sticky;
  top:0;
  background:#0b2442;
  color:#7dd3fc;
}

tfoot td{
  font-weight:800;
  color:#ffe08a;
}

/* =====================================================
   FOOTER
===================================================== */
footer{
  margin-top:30px;
  padding:16px;
  background:#000814;
  border-top:2px solid #f4b400;
}

.footer-inner{
  max-width:1200px;
  margin:auto;
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:10px;
}

.footer-title{
  font-weight:700;
}

.footer-sub{
  font-size:12px;
  color:#9ecbff;
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="header-logo">
      <img src="bartim.png" alt="Bartim">
    </div>
    <div class="header-title">
      <h1>Laporan Resmi Rasio Elektrifikasi</h1>
      <span>Kabupaten Barito Timur</span>
    </div>
  </div>
</header>

<div class="container">

  <!-- FILTER -->
  <div class="filter-box">
    <h3>üìÑ Pilih Periode Laporan (Snapshot)</h3>
    <div class="filter-form">
      <select id="tahun">
        <option value="">‚Äî Tahun ‚Äî</option>
        <option>2025</option>
        <option>2026</option>
        <option>2027</option>
      </select>
      <select id="triwulan">
        <option value="">‚Äî Triwulan ‚Äî</option>
        <option value="I">Triwulan I</option>
        <option value="II">Triwulan II</option>
        <option value="III">Triwulan III</option>
        <option value="IV">Triwulan IV</option>
      </select>
      <button onclick="loadLaporan()">üîç Tampilkan</button>
    </div>
  </div>

  <!-- INFO -->
  <div class="info-box" id="info" style="display:none">
    <div class="title" id="infoTitle"></div>
    <div class="value" id="infoValue"></div>
  </div>

  <!-- TABLE -->
  <div class="box-table">
    <div class="table-scroll">
      <table id="tbl">
        <thead>
  <tr>
    <th rowspan="2">No</th>
    <th rowspan="2">Kecamatan</th>
    <th rowspan="2">Desa / Kelurahan</th>

    <th colspan="2">Desa / Kelurahan Berlistrik</th>
    <th colspan="3">Rumah Tangga Berlistrik</th>

    <th rowspan="2">Jumlah Rumah Tangga<br>Belum Berlistrik</th>
    <th rowspan="2">Total Rumah Tangga</th>

    <th rowspan="2">Rasio Elektrifikasi PLN</th>
    <th rowspan="2">Rasio Elektrifikasi Non PLN</th>
    <th rowspan="2">Rasio Elektrifikasi</th>
    <th rowspan="2">% Rumah Tangga Tidak Berlistrik</th>
    <th rowspan="2">Keterangan</th>
  </tr>

  <tr>
    <th>PLN</th>
    <th>Non PLN</th>

    <th>PLN</th>
    <th>Non PLN</th>
    <th>Jumlah</th>
  </tr>
</thead>



        <tbody></tbody>
        <tfoot>
  <tr>
    <td colspan="3">TOTAL</td>

    <td>-</td>
    <td>-</td>

    <td id="tPln"></td>
    <td id="tNon"></td>
    <td id="tBerlistrik"></td>

    <td id="tTidak"></td>
    <td id="tJml"></td>
    <td></td>
  </tr>
</tfoot>


      </table>
    </div>
  </div>
<!-- ===================== JUDUL TABEL 2 ===================== -->
<div class="laporan-title">
  <div class="laporan-title-main">
    RASIO ELEKTRIFIKASI DAN RASIO KELURAHAN/DESA BERLISTRIK BARITO TIMUR
  </div>
  <div class="laporan-title-sub">
    PROVINSI KALIMANTAN TENGAH
  </div>
  <div class="laporan-title-periode">
    (REKAP PER KECAMATAN)
  </div>
</div>

<!-- ===================== TABEL 2 ===================== -->
<div class="box-table">
  <div class="table-scroll">
    <table id="tblRekap">
      <thead>
  <tr>
    <th rowspan="2">No</th>
    <th rowspan="2">Kecamatan</th>
    <th rowspan="2">Jumlah Kelurahan</th>
    <th rowspan="2">Jumlah Desa</th>

    <!-- DESA / KELURAHAN BERLISTRIK -->
    <th colspan="2">Desa / Kelurahan Berlistrik</th>

    <!-- DESA / KELURAHAN BELUM BERLISTRIK (BARU) -->
    <th rowspan="2">Desa / Kelurahan<br>Belum Berlistrik</th>

    <!-- RUMAH TANGGA BERLISTRIK -->
    <th colspan="3">Rumah Tangga Berlistrik</th>

    <th rowspan="2">Jumlah Rumah Tangga<br>Belum Berlistrik</th>
    <th rowspan="2">Total Rumah Tangga</th>

    <th rowspan="2">Rasio Elektrifikasi PLN</th>
    <th rowspan="2">Rasio Elektrifikasi Non PLN</th>
    <th rowspan="2">Rasio Elektrifikasi</th>
    <th rowspan="2">Rasio Desa Berlistrik</th>
  </tr>

  <tr>
    <!-- Sub kolom Desa Berlistrik -->
    <th>PLN</th>
    <th>Non PLN</th>

    <!-- Sub kolom RT Berlistrik -->
    <th>PLN</th>
    <th>Non PLN</th>
    <th>Jumlah</th>
  </tr>
</thead>


      <tbody>
        <!-- BARIS CONTOH AGAR TABEL TERLIHAT -->
        <tr>
          <td colspan="15" style="text-align:center;color:#9ecbff">
            Data rekap kecamatan akan tampil setelah perhitungan
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</div>

<footer>
  <div class="footer-inner">
    <div>
      <div class="footer-title">WebGIS Rasio Elektrifikasi</div>
      <div class="footer-sub">
        DPUPRPERKIM Kabupaten Barito Timur<br>
        Sekretariat Daerah Kabupaten Barito Timur
      </div>
    </div>
    <div class="footer-sub">
      ¬© 2025 ‚Äì Laporan Resmi (Snapshot Terkunci)
    </div>
  </div>
</footer>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxa-soCZiiqGB86ND1s5tKaIBwHSz0OGmv9OgJoDXYLKS1DvgcGy6e1sInZI3JD0oSm/exec";

/* ================= UTIL FORMAT ================= */
function formatPersen(v){
  if(v === null || v === undefined || v === "") return "0,00 %";
  const n = Number(String(v).replace(",", "."));
  if(isNaN(n)) return "0,00 %";
  return (n * 100).toLocaleString("id-ID", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) + " %";
}

/* ================= LOAD LAPORAN ================= */
function loadLaporan(){
  const tahun    = document.getElementById("tahun").value;
  const triwulan = document.getElementById("triwulan").value;

  if(!tahun || !triwulan){
    alert("Pilih tahun & triwulan");
    return;
  }

  fetch(`${API_URL}?action=getLaporan&tahun=${tahun}&triwulan=${triwulan}`)
    .then(r => r.json())
    .then(res => {

      if(res.status !== "ok"){
        alert(res.message || "Data tidak ditemukan");
        return;
      }

      /* ===================== TABEL 1 ===================== */
      const tb1 = document.querySelector("#tbl tbody");
      tb1.innerHTML = "";

      let sPln=0, sNon=0, sBerlistrik=0, sTidak=0, sJml=0;

      res.data.forEach((d,i)=>{
        const rtBerlistrik =
          (+d.rt_pln || 0) + (+d.rt_non_pln || 0);

        sPln += +d.rt_pln || 0;
        sNon += +d.rt_non_pln || 0;
        sBerlistrik += rtBerlistrik;
        sTidak += +d.rt_non_listrik || 0;
        sJml += +d.jumlah || 0;

        tb1.innerHTML += `
<tr>
  <td>${i+1}</td>
  <td>${d.kecamatan}</td>
  <td>${d.desa}</td>

  <td>${d.desa_pln || "-"}</td>
  <td>${d.desa_non_pln || "-"}</td>

  <td>${d.rt_pln}</td>
  <td>${d.rt_non_pln}</td>
  <td>${rtBerlistrik}</td>

  <td>${d.rt_non_listrik}</td>
  <td>${d.jumlah}</td>

  <td>${formatPersen(d.persen_pln)}</td>
  <td>${formatPersen(d.persen_non_pln)}</td>
  <td>${formatPersen(d.persen_berlistrik)}</td>
  <td>${formatPersen(d.persen_tidak_berlistrik)}</td>

  <td>-</td>
</tr>`;
      });

      document.getElementById("tPln").innerText = sPln;
      document.getElementById("tNon").innerText = sNon;
      document.getElementById("tBerlistrik").innerText = sBerlistrik;
      document.getElementById("tTidak").innerText = sTidak;
      document.getElementById("tJml").innerText = sJml;

      document.getElementById("info").style.display = "block";
      document.getElementById("infoTitle").innerText =
        `Laporan Resmi Triwulan ${triwulan} Tahun ${tahun}`;
      document.getElementById("infoValue").innerText =
        `${res.total_desa} Desa/Kelurahan`;

      /* ===================== TABEL 2 ===================== */
      const tb2 = document.querySelector("#tblRekap tbody");
      tb2.innerHTML = "";

      const map = {};

      res.data.forEach(d=>{
        if(!map[d.kecamatan]){
          map[d.kecamatan] = {
            jumlahDesa:0,
            jumlahKel:0,
            desaPln:0,
            desaNon:0,
            desaBerlistrik:0,
            rtPln:0,
            rtNon:0,
            rtBerlistrik:0,
            rtTidak:0,
            total:0
          };
        }

        const m = map[d.kecamatan];

        if(/^Desa\s/i.test(d.desa)) m.jumlahDesa++;
        else if(/^Kelurahan\s/i.test(d.desa)) m.jumlahKel++;

        if(d.desa_pln==="Ya" || d.desa_non_pln==="Ya") m.desaBerlistrik++;
        if(d.desa_pln==="Ya") m.desaPln++;
        if(d.desa_non_pln==="Ya") m.desaNon++;

        m.rtPln += +d.rt_pln || 0;
        m.rtNon += +d.rt_non_pln || 0;
        m.rtBerlistrik += (+d.rt_pln||0)+(+d.rt_non_pln||0);
        m.rtTidak += +d.rt_non_listrik || 0;
        m.total += +d.jumlah || 0;
      });

      let no=1;
      Object.keys(map).forEach(kec=>{
        const m = map[kec];
        const totalWilayah = m.jumlahDesa + m.jumlahKel;

        const desaBelum =
          m.desaBerlistrik < totalWilayah
            ? totalWilayah - m.desaBerlistrik
            : "-";

        const rPln = m.total ? m.rtPln/m.total : 0;
        const rNon = m.total ? m.rtNon/m.total : 0;
        const rTot = m.total ? m.rtBerlistrik/m.total : 0;
        const rDesa = totalWilayah ? m.desaBerlistrik/totalWilayah : 0;

        tb2.innerHTML += `
<tr>
  <td>${no++}</td>
  <td>${kec}</td>
  <td>${m.jumlahKel}</td>
  <td>${m.jumlahDesa}</td>
  <td>${m.desaPln}</td>
  <td>${m.desaNon}</td>
  <td>${desaBelum}</td>
  <td>${m.rtPln}</td>
  <td>${m.rtNon}</td>
  <td>${m.rtBerlistrik}</td>
  <td>${m.rtTidak}</td>
  <td>${m.total}</td>
  <td>${formatPersen(rPln)}</td>
  <td>${formatPersen(rNon)}</td>
  <td>${formatPersen(rTot)}</td>
  <td>${formatPersen(rDesa)}</td>
</tr>`;
      });

    }); // ‚úÖ TUTUP .then(res)
}        // ‚úÖ TUTUP function loadLaporan

/* === TOTAL === */
document.getElementById("tPln").innerText = sPln;
document.getElementById("tNon").innerText = sNon;
document.getElementById("tBerlistrik").innerText = sBerlistrik;
document.getElementById("tTidak").innerText = sTidak;
document.getElementById("tJml").innerText = sJml;

/* === INFO === */
document.getElementById("info").style.display = "block";
document.getElementById("infoTitle").innerText =
  `Laporan Resmi Triwulan ${triwulan} Tahun ${tahun}`;
document.getElementById("infoValue").innerText =
  `${res.total_desa} Desa/Kelurahan`;

   /* =====================================================
   ===================== TABEL 2 ======================
   REKAP PER KECAMATAN (FINAL ‚Äì FIX)
===================================================== */
const tb2 = document.querySelector("#tblRekap tbody");
if(!tb2) return;
tb2.innerHTML = "";

const map = {};

/* ===================== AGREGASI ===================== */
res.data.forEach(d=>{
  if(!map[d.kecamatan]){
    map[d.kecamatan] = {
      jumlahDesa: 0,
      jumlahKel: 0,

      desaPln: 0,
      desaNon: 0,
      desaBerlistrik: 0,

      rtPln: 0,
      rtNon: 0,
      rtBerlistrik: 0,
      rtTidak: 0,
      total: 0
    };
  }

  const m = map[d.kecamatan];

  /* === HITUNG DESA / KELURAHAN DARI NAMA === */
  if(/^Desa\s/i.test(d.desa)) {
    m.jumlahDesa++;
  } else if(/^Kelurahan\s/i.test(d.desa)) {
    m.jumlahKel++;
  }

  /* === STATUS DESA/KELURAHAN BERLISTRIK === */
  const isBerlistrik =
    d.desa_pln === "Ya" || d.desa_non_pln === "Ya";

  if(isBerlistrik) m.desaBerlistrik++;
  if(d.desa_pln === "Ya") m.desaPln++;
  if(d.desa_non_pln === "Ya") m.desaNon++;

  /* === RT === */
  m.rtPln += +d.rt_pln || 0;
  m.rtNon += +d.rt_non_pln || 0;
  m.rtBerlistrik += (+d.rt_pln || 0) + (+d.rt_non_pln || 0);
  m.rtTidak += +d.rt_non_listrik || 0;
  m.total += +d.jumlah || 0;
});

/* ===================== RENDER ===================== */
let no = 1;
Object.keys(map).forEach(kec=>{
  const m = map[kec];
  const totalWilayah = m.jumlahDesa + m.jumlahKel;

  /* === DESA/KELURAHAN BELUM BERLISTRIK === */
  const desaBelum =
    m.desaBerlistrik < totalWilayah
      ? totalWilayah - m.desaBerlistrik
      : "-";

  /* === RASIO === */
  const rPln  = m.total ? m.rtPln / m.total : 0;
  const rNon  = m.total ? m.rtNon / m.total : 0;
  const rTot  = m.total ? m.rtBerlistrik / m.total : 0;
  const rDesa = totalWilayah
    ? m.desaBerlistrik / totalWilayah
    : 0;

  tb2.innerHTML += `
<tr>
  <td>${no++}</td>
  <td>${kec}</td>
  <td>${m.jumlahKel}</td>
  <td>${m.jumlahDesa}</td>

  <td>${m.desaPln}</td>
  <td>${m.desaNon}</td>
  <td>${desaBelum}</td>

  <td>${m.rtPln}</td>
  <td>${m.rtNon}</td>
  <td>${m.rtBerlistrik}</td>

  <td>${m.rtTidak}</td>
  <td>${m.total}</td>

  <td>${formatPersen(rPln)}</td>
  <td>${formatPersen(rNon)}</td>
  <td>${formatPersen(rTot)}</td>
  <td>${formatPersen(rDesa)}</td>
</tr>`;
});

/* ===================== JUDUL PERIODE ===================== */
const jp = document.getElementById("judulPeriode");
if(jp) jp.innerText = `TRIWULAN ${triwulan} TAHUN ${tahun}`;

</script>


</body>
</html>
