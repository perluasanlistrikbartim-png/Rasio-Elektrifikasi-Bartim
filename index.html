<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebGIS Rasio Elektrifikasi ‚Äì Kabupaten Barito Timur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ================= BASIC ================= */
body{
  margin:0;
  background:#020216;
  color:#e0f7ff;
  font-family:Segoe UI, sans-serif;
}

/* ================= HEADER ================= */
header{
  padding:16px;
  background:#000814;
  border-bottom:3px solid #f4b400;
  position:relative;
  overflow:hidden;
}
header::after{
  content:"";
  position:absolute;
  top:0; left:-120%;
  width:120%;
  height:100%;
  background:linear-gradient(
    120deg,
    transparent 30%,
    rgba(255,255,255,.25),
    transparent 70%
  );
  animation:kilat 6s infinite;
}
@keyframes kilat{
  0%,85%{left:-120%}
  100%{left:120%}
}

.header-inner{
  max-width:1200px;
  margin:auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.title{text-align:center;flex:1}
.title h1{margin:0;font-size:1.4rem}
.title small{color:#ffe08a}

/* ================= CONTAINER ================= */
.container{
  max-width:1200px;
  margin:auto;
  padding:14px;
}

/* ================= FILTER ================= */
select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  font-size:15px;
  background:#071a33;
  color:#fff;
  margin-bottom:12px;
}

/* ================= MAP ================= */
#map{
  height:65vh;
  border-radius:16px;
  box-shadow:0 0 20px #000;
}

/* ================= SUMMARY ================= */
.summary-box{
  margin-top:14px;
  padding:16px;
  border-radius:16px;
  background:linear-gradient(135deg,#071a33,#050f22);
  box-shadow:0 0 25px rgba(0,180,255,.2);
  text-align:center;
}
.summary-title{
  font-size:14px;
  color:#9ecbff;
  margin-bottom:6px;
}
.summary-value{
  font-size:26px;
  font-weight:900;
  color:#00e5ff;
}
.summary-sub{
  margin-top:6px;
  font-size:12px;
  color:#c7eaff;
}

/* ================= TABLE ================= */
.box-table{
  margin-top:18px;
  background:linear-gradient(180deg,#071a33,#050f22);
  border-radius:18px;
  padding:14px;
}
.table-title{
  font-weight:700;
  color:#9ecbff;
  margin-bottom:10px;
}
.table-scroll{
  max-height:45vh;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
}
th,td{
  padding:8px 10px;
  border-bottom:1px solid rgba(0,180,255,.3);
}
th{
  position:sticky;
  top:0;
  background:#0b2442;
  color:#7dd3fc;
}

/* ================= PANEL ================= */
#panel{
  position:fixed;
  top:110px;
  right:20px;
  width:360px;
  background:#071a33;
  border-radius:18px;
  padding:14px;
  display:none;
  z-index:999;
}
.info-block{
  margin-bottom:8px;
  border-bottom:1px dashed rgba(255,255,255,.15);
}
.label{font-size:11px;color:#9ecbff}
.value{font-weight:700}

button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#00b4ff;
  font-weight:700;
  cursor:pointer;
}
  /* ================= CUSTOM MARKER ================= */
.marker-bartim{
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.marker-bartim img{
  width: 34px;        /* logo agak besar tapi elegan */
  height: 34px;
  filter: drop-shadow(0 0 6px rgba(0,180,255,.6));
}

.marker-label{
  margin-bottom: 6px;
  padding: 4px 10px;
  background: rgba(5,15,34,.85);
  color: #e0f7ff;
  font-size: 11px;
  font-weight: 600;
  border-radius: 10px;
  white-space: nowrap;
  box-shadow:
    0 4px 10px rgba(0,0,0,.6),
    0 0 12px rgba(0,180,255,.35);
}

/* kilat penghubung */
.marker-kilat{
  font-size: 14px;
  line-height: 14px;
  margin-bottom: 2px;
  color: #ffd700;
  text-shadow:
    0 0 6px rgba(255,215,0,.9),
    0 0 12px rgba(255,215,0,.6);
}

</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="title">
      <h1>WebGIS Rasio Elektrifikasi</h1>
      <small>Kabupaten Barito Timur</small>
    </div>
  </div>
</header>

<div class="container">
  <select id="filterKec">
    <option value="">‚Äî PILIH KECAMATAN ‚Äî</option>
    <option value="ALL">SEMUA KECAMATAN</option>
  </select>

  <div id="map"></div>

  <div id="summary" class="summary-box" style="display:none">
    <div class="summary-title" id="summaryTitle"></div>
    <div class="summary-value" id="summaryValue"></div>
    <div class="summary-sub" id="summarySub"></div>
  </div>
</div>

<div class="container">

  <!-- TABEL DESA -->
  <div class="box-table">
    <div class="table-title">üìä Data Rasio Elektrifikasi Desa</div>
    <div class="table-scroll">
      <table id="tbl">
        <thead>
          <tr>
            <th>No</th>
            <th>Kecamatan</th>
            <th>Desa/Kelurahan</th>
            <th>RT PLN</th>
            <th>RT Non PLN</th>
            <th>RT Non Listrik</th>
            <th>Jumlah RT</th>
            <th>% PLN</th>
            <th>% Non PLN</th>
            <th>% Tidak Berlistrik</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- REKAP KECAMATAN -->
  <div class="box-table" id="rekapBox" style="display:none">
    <div class="table-title">üìå Rekap Rasio Elektrifikasi per Kecamatan</div>
    <div class="table-scroll">
      <table id="rekapTbl">
        <thead>
          <tr>
            <th>Kecamatan</th>
            <th>RT PLN</th>
            <th>RT Non PLN</th>
            <th>RT Non Listrik</th>
            <th>Jumlah RT</th>
            <th>% PLN</th>
            <th>% Non PLN</th>
            <th>% Tidak Berlistrik</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- PANEL DETAIL -->
<div id="panel">
  <div class="info-block"><div class="label">Kecamatan</div><div class="value" id="pKec"></div></div>
  <div class="info-block"><div class="label">Desa/Kelurahan</div><div class="value" id="pTitle"></div></div>

  <div class="info-block"><div class="label">RT PLN</div><div class="value" id="pPln"></div></div>
  <div class="info-block"><div class="label">RT Non PLN</div><div class="value" id="pNon"></div></div>
  <div class="info-block"><div class="label">RT Non Listrik</div><div class="value" id="pNonListrik"></div></div>

  <div class="info-block"><div class="label">Jumlah RT</div><div class="value" id="pJml"></div></div>
  <div class="info-block"><div class="label">% PLN</div><div class="value" id="pPlnPersen"></div></div>
  <div class="info-block"><div class="label">% Non PLN</div><div class="value" id="pNonPlnPersen"></div></div>
  <div class="info-block"><div class="label">% Tidak Berlistrik</div><div class="value" id="pTidakPersen"></div></div>
  <div class="info-block"><div class="label">Updated</div><div class="value" id="pUpdated"></div></div>

  <button onclick="editData()">‚úèÔ∏è Edit Data</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_URL="https://script.google.com/macros/s/AKfycbxa-soCZiiqGB86ND1s5tKaIBwHSz0OGmv9OgJoDXYLKS1DvgcGy6e1sInZI3JD0oSm/exec";

/* ================= MAP ================= */
const map=L.map("map",{maxZoom:20}).setView([-2.1,115.1],8);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20}).addTo(map);
const layer=L.layerGroup().addTo(map);

/* ================= DATA ================= */
let data=[], selected=null;

/* ================= LOAD DATA ================= */
fetch(API_URL+"?action=getDesa")
.then(r=>r.json())
.then(j=>{
  data=j.data;
  [...new Set(data.map(d=>d.kecamatan))].forEach(k=>{
    let o=document.createElement("option");
    o.value=k;
    o.textContent=k;
    filterKec.appendChild(o);
  });
});

filterKec.onchange=render;

/* ================= RENDER ================= */
function render(){
  layer.clearLayers();
  const bounds = [];

  tbl.querySelector("tbody").innerHTML="";
  rekapTbl.querySelector("tbody").innerHTML="";
  panel.style.display="none";

  if(!filterKec.value) return;

  const list = filterKec.value==="ALL"
    ? data
    : data.filter(d=>d.kecamatan===filterKec.value);

  let sumPln=0, sumNon=0, sumTidak=0, sumTotal=0;
  let rekap={};

  list.forEach((d,i)=>{
    sumPln += +d.rt_pln || 0;
    sumNon += +d.rt_non_pln || 0;
    sumTidak += +d.rt_non_listrik || 0;
    sumTotal += +d.jumlah || 0;

    if(!rekap[d.kecamatan])
      rekap[d.kecamatan]={pln:0,non:0,tidak:0,total:0};

    rekap[d.kecamatan].pln += +d.rt_pln || 0;
    rekap[d.kecamatan].non += +d.rt_non_pln || 0;
    rekap[d.kecamatan].tidak += +d.rt_non_listrik || 0;
    rekap[d.kecamatan].total += +d.jumlah || 0;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${d.kecamatan}</td>
      <td>${d.nama_wilayah}</td>
      <td>${d.rt_pln}</td>
      <td>${d.rt_non_pln}</td>
      <td>${d.rt_non_listrik}</td>
      <td>${d.jumlah}</td>
      <td>${fmtPercent(d.persen_pln)}</td>
      <td>${fmtPercent(d.persen_non_pln)}</td>
      <td>${fmtPercent(d.persen_tidak_berlistrik)}</td>
      <td>${d.updated_at || "2025"}</td>
    `;
    tr.onclick=()=>show(d);
    tbl.querySelector("tbody").appendChild(tr);

    if(d.latitude && d.longitude){
  const latlng = [
    Number(d.latitude.toString().replace(",", ".")),
    Number(d.longitude.toString().replace(",", "."))
  ];

  const icon = L.divIcon({
    className: "",
    html: `
      <div class="marker-bartim">
        <div class="marker-label">${d.nama_wilayah}</div>
        <div class="marker-kilat">‚ö°</div>
        <img src="bartim.png" alt="Bartim">
      </div>
    `,
    iconSize: [40, 60],
    iconAnchor: [20, 60]
  });

  L.marker(latlng, { icon })
    .addTo(layer)
    .on("click",()=>show(d));

  bounds.push(latlng);
}

  });

  /* ===== FIT MAP TO MARKER ===== */
  if(bounds.length > 0){
    map.fitBounds(bounds,{
      padding:[40,40],
      maxZoom:13
    });
  }

  /* ===== SUMMARY ===== */
  const rasioKab = sumTotal ? (sumPln/sumTotal*100).toFixed(2) : "0.00";
  summary.style.display="block";

  if(filterKec.value==="ALL"){
    summaryTitle.innerText="Rasio Elektrifikasi PLN Kabupaten Barito Timur";
    rekapBox.style.display="block";
    rekapTbl.querySelector("tbody").innerHTML="";

    for(let k in rekap){
      const rPln=(rekap[k].pln/rekap[k].total*100).toFixed(2);
      const rNon=(rekap[k].non/rekap[k].total*100).toFixed(2);
      const rTidak=(rekap[k].tidak/rekap[k].total*100).toFixed(2);

      rekapTbl.querySelector("tbody").innerHTML+=`
        <tr>
          <td>${k}</td>
          <td>${rekap[k].pln}</td>
          <td>${rekap[k].non}</td>
          <td>${rekap[k].tidak}</td>
          <td>${rekap[k].total}</td>
          <td>${rPln}%</td>
          <td>${rNon}%</td>
          <td>${rTidak}%</td>
        </tr>`;
    }
  }else{
    summaryTitle.innerText="Rasio Elektrifikasi PLN Kecamatan "+filterKec.value;
    rekapBox.style.display="none";
  }

  summaryValue.innerText = rasioKab+"%";
  summarySub.innerText = `RT PLN: ${sumPln} | Total RT: ${sumTotal}`;
}

/* ================= PANEL VIEW ================= */
function show(d){
  selected=d;
  pKec.innerText=d.kecamatan;
  pTitle.innerText=d.nama_wilayah;
  pPln.innerText=d.rt_pln;
  pNon.innerText=d.rt_non_pln;
  pNonListrik.innerText=d.rt_non_listrik;
  pJml.innerText=d.jumlah;
  pPlnPersen.innerText = fmtPercent(d.persen_pln);
  pUpdated.innerText=d.updated_at || "2025";
  panel.style.display="block";
}

/* ================= UTIL ================= */
function fmtPercent(v){
  if(v===null || v==="") return "0.00%";
  if(String(v).includes("%")) return v;
  return (Number(v)*100).toFixed(2)+"%";
}

/* ================= EDIT + PIN ================= */
function editData(){
  if(!selected){
    alert("Pilih desa terlebih dahulu");
    return;
  }

  const pin = prompt(
    "Masukkan PIN Desa/Kelurahan:\n"+selected.nama_wilayah
  );
  if(!pin) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"checkPin",
      id_desa:selected.id_desa,
      pin:pin
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status!=="ok"){
      alert("PIN salah atau tidak aktif");
      return;
    }
    enableEditMode(pin);
  });
}

function enableEditMode(pin){
  panel.dataset.pin = pin;

  pPln.innerHTML = `<input id="ePln" type="number" value="${selected.rt_pln}">`;
  pNon.innerHTML = `<input id="eNon" type="number" value="${selected.rt_non_pln}">`;
  pNonListrik.innerHTML = `<input id="eNonListrik" type="number" value="${selected.rt_non_listrik||0}">`;

  panel.querySelector("button").outerHTML = `
    <button onclick="saveEdit()">üíæ Simpan</button>
    <button onclick="cancelEdit()">‚ùå Batal</button>
  `;
}

function cancelEdit(){
  show(selected);
}
</script>


</body>
</html>
