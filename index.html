<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS Rasio Elektrifikasi PLN â€“ Barito Timur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:radial-gradient(circle at center,#020216,#000010 70%,#000000);
  color:#e0f7ff; overflow:hidden;
}
#wrap{display:flex;height:100vh}
#map{flex:1}

/* PANEL */
#panel{
  width:380px;background:linear-gradient(180deg,#000814,#001122);
  border-left:2px solid #f4b400;padding:14px;overflow:auto;
}
#panel h3{margin:6px 0 10px;color:#f4b400;border-bottom:1px solid #333}
#panel b{color:#7dd3fc}
label{font-size:12px;color:#94a3b8;margin-top:6px;display:block}
input{
  width:100%;padding:7px;border-radius:6px;
  border:1px solid #333;background:#020216;color:#e0f7ff
}
button{
  background:linear-gradient(135deg,#f4b400,#ff9800);
  color:#000;border:none;border-radius:6px;
  padding:8px 14px;margin-top:10px;font-weight:600;cursor:pointer
}

/* LABEL DESA */
.label-desa{
  background:rgba(0,0,0,.75);
  border:1px solid #f4b400;
  border-radius:4px;
  padding:2px 6px;
  font-size:11px;
  font-weight:600;
  color:#f4b400;
}

/* TABLE */
#tblwrap{height:38vh;overflow:auto;background:#000814}
table{width:100%;border-collapse:collapse}
th{
  position:sticky;top:0;
  background:#001122;color:#f4b400;
  font-size:12px;padding:6px;border-bottom:2px solid #f4b400
}
td{padding:6px;font-size:12px;border-bottom:1px solid #222}
tr:hover{background:#001a33}
tr.active{background:#f4b400;color:#000;font-weight:600}
</style>
</head>

<body>

<div id="wrap">
  <div id="map"></div>

  <div id="panel">
    <h3 id="judul">Pilih Desa</h3>

    <!-- VIEW -->
    <div id="view">
      <div id="info"></div>
      <button onclick="openEdit()">EDIT</button>
    </div>

    <!-- EDIT -->
    <div id="edit" style="display:none">
      <label>Kecamatan</label>
      <input id="e_kecamatan" disabled>

      <label>Desa / Kelurahan</label>
      <input id="e_desa" disabled>

      <label>Rumah Tangga Berlistrik PLN</label>
      <input id="rt_pln" type="number">

      <label>Rumah Tangga Berlistrik Non PLN</label>
      <input id="rt_non_pln" type="number">

      <label>Jumlah Rumah Tangga</label>
      <input id="e_jumlah" disabled>

      <label>Rasio Elektrifikasi PLN (%)</label>
      <input id="e_rasio" disabled>

      <label>Keterangan</label>
      <input id="e_ket" disabled>

      <button onclick="save()">SIMPAN</button>
      <button onclick="cancelEdit()">BATAL</button>
    </div>
  </div>
</div>

<div id="tblwrap">
<table id="tbl">
<thead>
<tr>
<th>No</th>
<th>Kecamatan</th>
<th>Desa/Kelurahan</th>
<th>RT PLN</th>
<th>RT Non PLN</th>
<th>Jumlah</th>
<th>Rasio PLN (%)</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API="https://script.google.com/macros/s/AKfycbxa-soCZiiqGB86ND1s5tKaIBwHSz0OGmv9OgJoDXYLKS1DvgcGy6e1sInZI3JD0oSm/exec";

let map=L.map('map').setView([-2.0,115.2],8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],selected=null;

fetch(API+'?action=getDesa')
.then(r=>r.json())
.then(j=>{
  data=j.data;
  renderMap();
  renderTable();
});

function renderMap(){
  data.forEach(d=>{
    if(!d.latitude || !d.longitude) return;
    let m=L.marker([Number(d.latitude),Number(d.longitude)]).addTo(map);
    m.bindTooltip(d.nama_wilayah,{permanent:true,direction:'top',className:'label-desa'});
    m.on('click',()=>select(d.id_desa));
  });
}

function renderTable(){
  const tb=document.querySelector('#tbl tbody');
  tb.innerHTML='';
  data.forEach((d,i)=>{
    let tr=document.createElement('tr');
    tr.id='row_'+d.id_desa;
    tr.onclick=()=>select(d.id_desa);
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${d.kecamatan}</td>
      <td>${d.nama_wilayah}</td>
      <td>${d.rt_pln}</td>
      <td>${d.rt_non_pln}</td>
      <td>${d.jumlah}</td>
      <td>${Number(d.rasio_pln).toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
}

function select(id){
  selected=data.find(x=>x.id_desa===id);
  document.querySelectorAll('tr').forEach(r=>r.classList.remove('active'));
  document.getElementById('row_'+id)?.classList.add('active');

  map.setView([Number(selected.latitude),Number(selected.longitude)],12);
  document.getElementById('judul').innerText=selected.nama_wilayah;

  document.getElementById('info').innerHTML=`
    Kecamatan : <b>${selected.kecamatan}</b><br>
    Desa/Kelurahan : <b>${selected.nama_wilayah}</b><br>
    RT Berlistrik PLN : <b>${selected.rt_pln}</b><br>
    RT Berlistrik Non PLN : <b>${selected.rt_non_pln}</b><br>
    Jumlah Rumah Tangga : <b>${selected.jumlah}</b><br>
    Rasio Elektrifikasi PLN : <b>${Number(selected.rasio_pln).toFixed(2)}%</b><br>
    Keterangan : <b>${selected.ket || '-'}</b>
  `;
}

function openEdit(){
  let pin=prompt("Masukkan PIN");
  fetch(API,{method:'POST',body:JSON.stringify({action:'checkPin',pin})})
  .then(r=>r.json())
  .then(j=>{
    if(j.status==='ok'){
      view.style.display='none';
      edit.style.display='block';

      e_kecamatan.value=selected.kecamatan;
      e_desa.value=selected.nama_wilayah;
      rt_pln.value=selected.rt_pln;
      rt_non_pln.value=selected.rt_non_pln;
      e_jumlah.value=selected.jumlah;
      e_rasio.value=Number(selected.rasio_pln).toFixed(2);
      e_ket.value=selected.ket || '-';

      window._pin=pin;
    } else alert("PIN salah");
  });
}

function cancelEdit(){
  edit.style.display='none';
  view.style.display='block';
}

function save(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'updateDesa',
      id_desa:selected.id_desa,
      rt_pln:Number(rt_pln.value),
      rt_non_pln:Number(rt_non_pln.value),
      pin:window._pin
    })
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status==='ok') location.reload();
    else alert(j.message);
  });
}
</script>
</body>
</html>
