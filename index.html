<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS Rasio Elektrifikasi PLN – Barito Timur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:radial-gradient(circle at center,#020216,#000010 70%,#000000);
  color:#e0f7ff;
  overflow:hidden;
}

/* ===== FX ===== */
#neon-road{
  position:fixed;inset:0;
  background:
    linear-gradient(180deg,transparent 70%,rgba(244,180,0,.25)),
    repeating-linear-gradient(
      90deg,
      rgba(244,180,0,.08) 0px,
      rgba(244,180,0,.08) 2px,
      transparent 2px,
      transparent 120px
    );
  animation:roadMove 24s linear infinite;
  pointer-events:none;z-index:0;
}
@keyframes roadMove{
  from{background-position:0 0}
  to{background-position:1400px 0}
}

body::before{
  content:"";
  position:fixed;
  inset:12px;
  border:2px solid #f4b400;
  border-radius:16px;
  box-shadow:0 0 20px rgba(244,180,0,.35);
  pointer-events:none;
  z-index:9;
}

/* ===== LAYOUT ===== */
#wrap{display:flex;height:100vh;z-index:2;position:relative}
#map{flex:1}
#panel{
  width:380px;
  background:linear-gradient(180deg,#000814,#001122);
  border-left:2px solid #f4b400;
  padding:14px;
  overflow:auto;
}

/* ===== PANEL ===== */
h3{
  margin:6px 0 10px;
  color:#f4b400;
  border-bottom:1px solid #333;
}

label{font-size:12px;color:#94a3b8;margin-top:6px;display:block}
select,input{
  width:100%;padding:7px;border-radius:6px;
  border:1px solid #333;background:#020216;color:#e0f7ff
}
button{
  background:linear-gradient(135deg,#f4b400,#ff9800);
  color:#000;border:none;border-radius:6px;
  padding:8px 14px;margin-top:10px;font-weight:600;cursor:pointer
}

/* ===== LABEL ===== */
.label-desa{
  background:rgba(0,0,0,.75);
  border:1px solid #f4b400;
  border-radius:4px;
  padding:2px 6px;
  font-size:11px;
  font-weight:600;
  color:#f4b400;
}

/* ===== TABLE ===== */
#tblwrap{height:38vh;overflow:auto;background:#000814}
table{width:100%;border-collapse:collapse}
th{
  position:sticky;top:0;
  background:#001122;color:#f4b400;
  font-size:12px;padding:6px;border-bottom:2px solid #f4b400
}
td{padding:6px;font-size:12px;border-bottom:1px solid #222}
tr:hover{background:#001a33}
tr.active{background:#f4b400;color:#000;font-weight:600}
</style>
</head>

<body>

<div id="neon-road"></div>

<div id="wrap">
  <div id="map"></div>

  <div id="panel">
    <h3>Filter Kecamatan</h3>

    <label>Pilih Kecamatan</label>
    <select id="filterKecamatan">
      <option value="">-- pilih kecamatan --</option>
      <option value="ALL">Semua Kecamatan</option>
    </select>

    <h3 id="judul">Belum ada data</h3>

    <div id="view">
      <div id="info">Silakan pilih kecamatan terlebih dahulu.</div>
      <button onclick="openEdit()">EDIT</button>
    </div>

    <div id="edit" style="display:none">
      <label>Kecamatan</label>
      <input id="e_kecamatan" disabled>

      <label>Desa</label>
      <input id="e_desa" disabled>

      <label>RT PLN</label>
      <input id="rt_pln" type="number">

      <label>RT Non PLN</label>
      <input id="rt_non_pln" type="number">

      <label>Jumlah</label>
      <input id="e_jumlah" disabled>

      <label>Rasio (%)</label>
      <input id="e_rasio" disabled>

      <button onclick="save()">SIMPAN</button>
      <button onclick="cancelEdit()">BATAL</button>
    </div>
  </div>
</div>

<div id="tblwrap">
<table id="tbl">
<thead>
<tr>
<th>No</th>
<th>Kecamatan</th>
<th>Desa</th>
<th>RT PLN</th>
<th>RT Non PLN</th>
<th>Jumlah</th>
<th>Rasio</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API="https://script.google.com/macros/s/AKfycbxa-soCZiiqGB86ND1s5tKaIBwHSz0OGmv9OgJoDXYLKS1DvgcGy6e1sInZI3JD0oSm/exec";

let map=L.map('map',{
  zoomControl:true,
  minZoom:7,
  maxZoom:10   // ⬅️ zoom dibatasi
}).setView([-2.0,115.2],8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let data=[],layer=L.layerGroup().addTo(map),selected=null;
let zoomLocked=false;

/* ===== LOAD DATA ===== */
fetch(API+'?action=getDesa')
.then(r=>r.json())
.then(j=>{
  data=j.data;
  initFilter();
});

/* ===== INIT FILTER ===== */
function initFilter(){
  const kec=[...new Set(data.map(d=>d.kecamatan))];
  const sel=document.getElementById('filterKecamatan');
  kec.forEach(k=>{
    let o=document.createElement('option');
    o.value=k;o.textContent=k;
    sel.appendChild(o);
  });

  sel.onchange=()=>applyFilter(sel.value);
}

/* ===== APPLY FILTER ===== */
function applyFilter(kec){
  layer.clearLayers();
  document.querySelector('#tbl tbody').innerHTML='';
  selected=null;

  if(!kec){
    document.getElementById('judul').innerText='Belum ada data';
    document.getElementById('info').innerText='Pilih kecamatan untuk menampilkan data.';
    return;
  }

  let filtered=(kec==='ALL')?data:data.filter(d=>d.kecamatan===kec);

  let bounds=[];
  filtered.forEach((d,i)=>{
    if(!d.latitude||!d.longitude) return;

    let m=L.marker([+d.latitude,+d.longitude]).addTo(layer);
    m.bindTooltip(d.nama_wilayah,{permanent:true,className:'label-desa'});
    m.on('click',()=>select(d.id_desa));

    bounds.push([+d.latitude,+d.longitude]);

    let tr=document.createElement('tr');
    tr.id='row_'+d.id_desa;
    tr.onclick=()=>select(d.id_desa);
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${d.kecamatan}</td>
      <td>${d.nama_wilayah}</td>
      <td>${d.rt_pln}</td>
      <td>${d.rt_non_pln}</td>
      <td>${d.jumlah}</td>
      <td>${(+d.rasio_pln).toFixed(2)}</td>`;
    document.querySelector('#tbl tbody').appendChild(tr);
  });

  if(bounds.length){
    map.fitBounds(bounds,{maxZoom:9});
    if(!zoomLocked){
      map.once('zoomend',()=>map.dragging.enable());
      map.dragging.disable();
      zoomLocked=true;
    }
  }
}

/* ===== SELECT ===== */
function select(id){
  selected=data.find(x=>x.id_desa===id);
  document.querySelectorAll('tr').forEach(r=>r.classList.remove('active'));
  document.getElementById('row_'+id)?.classList.add('active');

  map.setView([+selected.latitude,+selected.longitude],10);

  judul.innerText=selected.nama_wilayah;
  info.innerHTML=`
    Kecamatan : <b>${selected.kecamatan}</b><br>
    RT PLN : <b>${selected.rt_pln}</b><br>
    RT Non PLN : <b>${selected.rt_non_pln}</b><br>
    Jumlah : <b>${selected.jumlah}</b><br>
    Rasio : <b>${(+selected.rasio_pln).toFixed(2)}%</b>
  `;
}

/* ===== EDIT ===== */
function openEdit(){
  if(!selected) return alert("Pilih desa terlebih dahulu");
  let pin=prompt("Masukkan PIN");
  fetch(API,{method:'POST',body:JSON.stringify({action:'checkPin',pin})})
  .then(r=>r.json())
  .then(j=>{
    if(j.status==='ok'){
      view.style.display='none';
      edit.style.display='block';
      e_kecamatan.value=selected.kecamatan;
      e_desa.value=selected.nama_wilayah;
      rt_pln.value=selected.rt_pln;
      rt_non_pln.value=selected.rt_non_pln;
      e_jumlah.value=selected.jumlah;
      e_rasio.value=(+selected.rasio_pln).toFixed(2);
      window._pin=pin;
    }else alert("PIN salah");
  });
}

function cancelEdit(){
  edit.style.display='none';
  view.style.display='block';
}

function save(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'updateDesa',
      id_desa:selected.id_desa,
      rt_pln:+rt_pln.value,
      rt_non_pln:+rt_non_pln.value,
      pin:window._pin
    })
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status==='ok') location.reload();
    else alert(j.message);
  });
}
</script>
</body>
</html>
